---
- hosts: tlog-machine

  vars:
    arch: x86_64
    source_dir: tlog-source
    # could be file/syslog/es
    tlog_writer: syslog
    tlog_logfile: /var/log/tlog.log
    tlog_priority: info
    tlog_facility: local5

    tlog_reader: file

    es_forward: false
    # set elasticsearch ip and port
    es_ip: 192.168.122.250
    es_port: 9200

  tasks:
# tlog part

  - name: installing git
    yum: name=git state=latest

  - name: installing libtool
    yum: name=libtool state=latest

  - name: installing autoconf
    yum: name=autoconf state=latest

  - name: installing automake
    yum: name=automake state=latest

  - name: installing json-c-devel
    yum: name=json-c-devel state=latest

  - name: installing systemd-devel
    yum: name=systemd-devel state=latest

  - name: installing libcurl-devel
    yum: name=libcurl-devel state=latest

  - name: installing rpm-build
    yum: name=rpm-build state=latest

  - name: clone tlog
    git:
      repo: https://github.com/Scribery/tlog.git
      dest: /tmp/{{ source_dir }}

  - name: build tlog
    shell: |
      cd /tmp/tlog-source
      autoreconf -i -f
      ./configure --prefix=/usr --sysconfdir=/etc && make dist
      rpmbuild -tb tlog-4.tar.gz

  - name: install tlog
    shell: yum install -y /root/rpmbuild/RPMS/{{ arch }}/tlog*

  - name: tlog cleanup
    file: name=/root/rpmbuild state=absent

  - name: tlog cleanup source
    file: name=/tmp/{{ source_dir }} state=absent

  - name: copying tlog-rec.conf
    template: src=tlog-rec.conf.j2 dest=/etc/tlog/tlog-rec.conf

  - name: copying tlog-play.conf
    template: src=tlog-play.conf.j2 dest=/etc/tlog/tlog-play.conf
   
# selinux port
  - name: install policycoreutils-python
    yum: name=policycoreutils-python state=latest

  - name: enable port {{ es_port }}
    shell: semanage port -a -t syslogd_port_t -p tcp {{ es_port }} || true 

# rsyslog part
  - name: installing rsyslog
    yum: name=rsyslog state=latest

  - name: installing rsyslog-elasticsearch
    yum: name=rsyslog-elasticsearch state=latest

  - name: write the rsyslog config file
    template: src=rsyslog.conf.j2 dest=/etc/rsyslog.conf

  - name: restart the rsyslog service
    service: name=rsyslog state=restarted enabled=yes
